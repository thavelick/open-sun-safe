<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sun Safety Tracker</title>
  <style>
  /* ========== CSS VARIABLES & RESET ========== */
  :root {
    --primary-color: #ff9500;
    --secondary-color: #ffb347;
    --dark-color: #333;
    --light-color: #f4f4f4;
    --danger-color: #ff4757;
    --success-color: #2ed573;
    --warning-color: #ffa502;
    --info-color: #70a1ff;
    --border-radius: 8px;
    --box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    --transition: all .3s ease;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height:1.6;
    background:#f9f9f9;
    color:var(--dark-color);
  }
  .container { max-width:800px; margin:20px auto; padding:0 20px; }

  /* ========== HEADER ========== */
  header { text-align:center; margin-bottom:20px; }
  header h1 {
    display:inline-flex;
    align-items:center;
    gap:8px;
    font-size:2rem;
    color:var(--primary-color);
  }

  /* ========== TABS ========== */
  .tabs { display:flex; width:100%; margin-bottom:20px; border:1px solid #ddd; border-radius:var(--border-radius); overflow:hidden;}
  .tab-button {
    flex:1;
    padding:10px;
    background:#fafafa;
    border:none;
    cursor:pointer;
    transition:var(--transition);
    font-weight:500;
    color: var(--dark-color);
  }
  .tab-button.active {
    background:white;
    color:var(--dark-color);
    box-shadow: inset 0 -2px 0 var(--primary-color);
  }
  .tab-button:hover { background:#fff; }

  /* ========== VIEWS ========== */
  .view { display:none; }
  .view.active { display:block; }

  /* ========== LOADING ========== */
  .loading-container {
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    padding:40px 0;
  }
  .loading-spinner {
    width:40px; height:40px;
    border:4px solid #f3f3f3;
    border-top:4px solid var(--primary-color);
    border-radius:50%;
    animation:spin 1s linear infinite;
    margin-bottom:12px;
  }
  @keyframes spin { 0%{transform:rotate(0)}100%{transform:rotate(360deg)} }

  /* ========== CARDS & BUTTONS ========== */
  .card {
    background:white;
    border-radius:var(--border-radius);
    box-shadow:var(--box-shadow);
    margin-bottom:20px;
  }
  .card .card-header {
    border-bottom:1px solid #eee;
    padding:12px 16px;
  }
  .card .card-header h2 { margin:0; font-size:1.2rem; color:var(--dark-color); }
  .card .card-content { padding:16px; }

  button, input, select {
    font-family:inherit;
    font-size:1rem;
    transition:var(--transition);
  }
  button {
    background:var(--primary-color);
    color:white;
    border:none;
    border-radius:var(--border-radius);
    padding:8px 16px;
    cursor:pointer;
  }
  button:hover { background:#e08900; }
  button.secondary {
    background:var(--info-color);
    color:white;
  }
  button.secondary:hover { background:#5a8dee; }

  .save-button {
    display:block;
    width:100%;
    background:var(--success-color);
    margin-top:10px;
  }
  .save-button:hover { background:#26bb62; }

  /* ========== FORMS ========== */
  .form-group { margin-bottom:16px; }
  label { display:block; margin-bottom:4px; font-weight:600; }
  input, select {
    width:100%;
    padding:8px;
    border:1px solid #ddd;
    border-radius:var(--border-radius);
  }

  /* ========== HOME LAYOUT ========== */
  #home-content { display:flex; flex-direction:column; align-items:center; gap:20px; }
  #circle-widget { width:280px; height:280px; cursor:pointer; position:relative; }
  #safe-time-card { width:100%; }
  #safe-time {
    text-align:center;
    font-size:2.5rem;
    color:var(--primary-color);
    margin:8px 0;
  }
  #location-refresh {
    display:flex;
    justify-content:space-between;
    align-items:center;
    width:100%;
  }
  #location-info { font-size:.9rem; color:#555; }

  /* ========== CIRCLE CENTER ========== */
  .center-info {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:160px; height:160px;
    background:var(--dark-color);
    border-radius:50%;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    color:white;
    text-align:center;
  }
  .center-info .time { font-size:1rem; }
  .center-info .uvi { font-size:2.5rem; color:var(--primary-color); }
  .center-info .label { font-size:.9rem; }

  /* ========== SETTINGS LAYOUT ========== */
  #settings-form { width:100%; }

  /* ========== ABOUT ========== */
  #about ul { margin-top:8px; margin-left:20px; }
  #about li { margin-bottom:4px; }

  /* ========== RESPONSIVE ========== */
  @media (max-width:600px){
    #location-refresh { flex-direction:column; gap:10px; }
    button { width:100%; }
  }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>☀️ Sun Safety Tracker</h1>
  </header>

  <!-- TABS -->
  <div class="tabs">
    <button id="tab-home" class="tab-button active">Home</button>
    <button id="tab-settings" class="tab-button">Settings</button>
  </div>

  <!-- HOME VIEW -->
  <div id="view-home" class="view active">
    <div id="loading" class="loading-container" style="display:none">
      <div class="loading-spinner"></div>
      <div>Loading UV data…</div>
    </div>

    <!-- message when no settings or no data -->
    <div id="message" style="width:100%;"></div>

    <!-- main home content -->
    <div id="home-content" style="display:none">
      <div id="circle-widget"></div>

      <div id="safe-time-card" class="card">
        <div class="card-header"><h2>Safe Sun Exposure</h2></div>
        <div class="card-content">
          <div id="safe-time">0 min</div>
          <div style="color:#666; font-size:.9rem;">estimated safe time without sunscreen</div>
          <div style="margin-top:6px; font-size:.9rem;">
            Based on skin type: <span id="skin-display" style="font-weight:600;"></span>
          </div>
        </div>
      </div>

      <div id="location-refresh">
        <div id="location-info"></div>
        <button id="refresh-btn" class="secondary">Refresh</button>
      </div>
    </div>
  </div>

  <!-- SETTINGS VIEW -->
  <div id="view-settings" class="view">
    <div class="card">
      <div class="card-header"><h2>Settings</h2></div>
      <div class="card-content">
        <form id="settings-form">
          <div class="form-group">
            <label for="inp-lat">Latitude</label>
            <input id="inp-lat" type="number" step="0.0001" required />
          </div>
          <div class="form-group">
            <label for="inp-lng">Longitude</label>
            <input id="inp-lng" type="number" step="0.0001" required />
          </div>
          <div class="form-group">
            <label for="inp-skin">Fitzpatrick Skin Type</label>
            <select id="inp-skin" required>
              <option value="">Select…</option>
              <option value="1">Type I – Very fair, always burns</option>
              <option value="2">Type II – Fair, burns easily</option>
              <option value="3">Type III – Medium, burns moderately</option>
              <option value="4">Type IV – Olive, burns minimally</option>
              <option value="5">Type V – Brown, rarely burns</option>
              <option value="6">Type VI – Dark brown/black, never burns</option>
            </select>
          </div>
          <button type="submit" class="save-button">Save Settings</button>
        </form>
      </div>
    </div>

    <div id="about" class="card">
      <div class="card-header"><h2>About the Fitzpatrick Scale</h2></div>
      <div class="card-content">
        <p>The Fitzpatrick scale classifies skin types based on how they respond to sun exposure:</p>
        <ul>
          <li><strong>Type I:</strong> Very fair skin, always burns, never tans</li>
          <li><strong>Type II:</strong> Fair skin, burns easily, tans minimally</li>
          <li><strong>Type III:</strong> Medium skin, burns moderately, tans gradually</li>
          <li><strong>Type IV:</strong> Olive skin, burns minimally, tans well</li>
          <li><strong>Type V:</strong> Brown skin, rarely burns, tans darkly</li>
          <li><strong>Type VI:</strong> Dark brown/black skin, never burns</li>
        </ul>
      </div>
    </div>
  </div>
</div><!-- /container -->

<script>
;(function(){
  // ===== CONSTANTS =====
  const SETTINGS_KEY = "sunSafetySettings";
  const UVDATA_KEY   = "sunSafetyUvData";
  const EXPIRY       = 24*60*60*1000; // ms
  const MED_VALUES = {
    "1":200, "2":250, "3":300,
    "4":450, "5":600, "6":1000
  };

  // ===== STATE =====
  let settings = { latitude:"", longitude:"", skinType:"" };
  let uvData   = null;
  let lastTs   = null;
  let selectedTime = null;

  // ===== DOM REFS =====
  const tabHome       = document.getElementById("tab-home");
  const tabSettings   = document.getElementById("tab-settings");
  const viewHome      = document.getElementById("view-home");
  const viewSettings  = document.getElementById("view-settings");
  const loadingEl     = document.getElementById("loading");
  const messageEl     = document.getElementById("message");
  const homeContentEl = document.getElementById("home-content");
  const circleEl      = document.getElementById("circle-widget");
  const safeTimeEl    = document.getElementById("safe-time");
  const skinDisplayEl = document.getElementById("skin-display");
  const locInfoEl     = document.getElementById("location-info");
  const refreshBtn    = document.getElementById("refresh-btn");

  const form          = document.getElementById("settings-form");
  const inpLat        = document.getElementById("inp-lat");
  const inpLng        = document.getElementById("inp-lng");
  const inpSkin       = document.getElementById("inp-skin");

  // ===== UTILITIES =====
  function saveSettings() {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }
  function loadSettings() {
    const s = localStorage.getItem(SETTINGS_KEY);
    if (s) {
      try {
        settings = JSON.parse(s);
      } catch(_){}
    }
  }
  function isSettingsReady() {
    return settings.latitude && settings.longitude && settings.skinType;
  }
  function saveUvStorage(data) {
    const payload = { data, ts:Date.now() };
    localStorage.setItem(UVDATA_KEY, JSON.stringify(payload));
    lastTs = new Date(payload.ts);
  }
  function loadUvStorage() {
    const s = localStorage.getItem(UVDATA_KEY);
    if (!s) return false;
    try {
      const { data, ts } = JSON.parse(s);
      if (Date.now() - ts < EXPIRY) {
        uvData = data;
        lastTs = new Date(ts);
        return true;
      }
    } catch(_){}
    return false;
  }
  function wrapCurrency(num){
    return (num<10? "0"+num : num);
  }
  function formatTime(str) {
    const d = new Date(str);
    let h = d.getHours();
    let ampm = h>=12?"PM":"AM";
    h = h%12||12;
    return h + ":" + wrapCurrency(d.getMinutes()) + " " + ampm;
  }
  function formatDate(d) {
    return d.toLocaleString([], {
      month:"short", day:"numeric", hour:"2-digit", minute:"2-digit"
    });
  }
  function getAllPoints() {
    if (!uvData) return [];
    return [
      ...(uvData.history||[]),
      uvData.now,
      ...(uvData.forecast||[])
    ].sort((a,b)=> new Date(a.time) - new Date(b.time));
  }
  function findClosest(tp) {
    const pts = getAllPoints();
    const tgt = new Date(tp).getTime();
    let best = pts[0], md = Math.abs(new Date(pts[0].time).getTime()-tgt);
    for(let i=1;i<pts.length;i++){
      const d = Math.abs(new Date(pts[i].time).getTime()-tgt);
      if (d<md){ md=d; best=pts[i]; }
    }
    return best;
  }
  function getRisk(u) {
    if (u < 1) return { label: "No UV", color: "#1E90FF" };      // Dodger Blue (bluish)
    if (u < 2) return { label: "Low UV", color: "#2ed573" };     // Medium Spring Green (greenish)
    if (u < 6) return { label: "Moderate UV", color: "#ffa502" }; // Orange
    if (u < 8) return { label: "High UV", color: "#ff7f50" };     // Coral
    if (u < 11) return { label: "Very High UV", color: "#ff4757" }; // Red-Orange
    return { label: "Extreme UV", color: "#9c27b0" };              // Purple
  }
  function calcSafeTime(u, skin) {
    if (!u|| u<=0|| !skin|| !MED_VALUES[skin]) return 0;
    const MED = MED_VALUES[skin];
    const rate = u * 0.025; // J/m2 per min
    const mins = MED / rate;
    return Math.floor(mins) / 60
  }

  // ===== UI UPDATES =====
  function switchTab(tab) {
    if (tab==="home") {
      tabHome.classList.add("active");
      tabSettings.classList.remove("active");
      viewHome.classList.add("active");
      viewSettings.classList.remove("active");
    } else {
      tabHome.classList.remove("active");
      tabSettings.classList.add("active");
      viewHome.classList.remove("active");
      viewSettings.classList.add("active");
    }
  }

  function showMessage(html) {
    messageEl.innerHTML = html;
    messageEl.style.display = "block";
  }
  function hideMessage() {
    messageEl.style.display = "none";
    messageEl.innerHTML = "";
  }

  function renderHome() {
    // if no settings:
    if (!isSettingsReady()) {
      homeContentEl.style.display = "none";
      hideLoading();
      showMessage(`
        <div class="card">
          <div class="card-content" style="text-align:center;padding:24px">
            <p>Please complete settings to view data.</p>
            <button onclick="switchTab('settings')">Go to Settings</button>
          </div>
        </div>`);
      return;
    }
    // if no UV data:
    if (!uvData) {
      homeContentEl.style.display = "none";
      hideLoading();
      showMessage(`
        <div class="card">
          <div class="card-content" style="text-align:center;padding:24px">
            <p>No UV data available.</p>
            <button id="btn-fetch">Fetch UV Data</button>
          </div>
        </div>`);
      document.getElementById("btn-fetch").onclick = ()=>fetchUv(true);
      return;
    }

    // render:
    hideMessage();
    hideLoading();
    homeContentEl.style.display = "flex";

    // safe time
    const uvi = uvData.now.uvi;
    safeTimeEl.textContent = calcSafeTime(uvi, settings.skinType) + " min";
    const skinMap = {
      "1":"Type I (Very fair)",
      "2":"Type II (Fair)",
      "3":"Type III (Medium)",
      "4":"Type IV (Olive)",
      "5":"Type V (Brown)",
      "6":"Type VI (Dark)"
    };
    skinDisplayEl.textContent = skinMap[settings.skinType]||"";

    // location + last updated
    let txt = `Location: ${settings.latitude}, ${settings.longitude}`;
    if (lastTs) txt += `<br>Last: ${formatDate(lastTs)}`;
    locInfoEl.innerHTML = txt;

    // circle
    buildCircle();
  }

  function showLoading() {
    loadingEl.style.display = "flex";
    homeContentEl.style.display = "none";
    hideMessage();
  }
  function hideLoading() {
    loadingEl.style.display = "none";
  }

  // ===== CIRCLE WIDGET =====
  function buildCircle() {
    const pts = getAllPoints();
    if (!pts.length) return;
    const nowT = uvData.now.time;
    selectedTime = selectedTime||nowT;
    const selPt = findClosest(selectedTime);

    // build SVG+gradient+dots
    let svg = `<svg viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">`;
    svg += `<defs>
      <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
        <stop offset="0%"  stop-color="#2ed573"/>
        <stop offset="25%" stop-color="#ffa502"/>
        <stop offset="50%" stop-color="#ff7f50"/>
        <stop offset="75%" stop-color="#ff4757"/>
        <stop offset="100%"stop-color="#9c27b0"/>
      </linearGradient>
    </defs>`;
    svg += `<circle cx="50" cy="50" r="45" fill="none" stroke="url(#grad)" stroke-width="8"/>`;
    // draw dot at selected hour
    const selectedHour = new Date(selPt.time).getHours() % 12 || 12;
    const angle = (selectedHour * 30 - 90) * Math.PI / 180;
    const x = 50 + Math.cos(angle) * 42;
    const y = 50 + Math.sin(angle) * 42;
    svg += `<circle cx="${x.toFixed(2)}" cy="${y.toFixed(2)}" r="2" fill="var(--primary-color)"/>`;

    svg += `</svg>`;

    // center info
    const risk = getRisk(selPt.uvi);
    const center = `
      <div class="center-info">
        <div class="time">${formatTime(selPt.time)}</div>
        <div class="uvi">${selPt.uvi.toFixed(1)}</div>
        <div class="label">${risk.label}</div>
      </div>`;

    circleEl.innerHTML = svg + center;

    // attach click:
    circleEl.onclick = (ev)=>{
      const rect = circleEl.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top  + rect.height/2;
      const dx = ev.clientX - cx;
      const dy = ev.clientY - cy;
      // compute click angle from top (12 o'clock)
      let clickAngle = Math.atan2(dx, -dy) * (180/Math.PI);
      if (clickAngle < 0) clickAngle += 360;
      // find nearest point by angle
      let closestPt = null;
      let minDiff = 360;
      pts.forEach(pt=>{
        const dt = new Date(pt.time);
        let hr = dt.getHours() % 12;
        const mn = dt.getMinutes() / 60;
        let ptAngle = (hr + mn) * 30;
        if (ptAngle < 0) ptAngle += 360;
        const diff = Math.abs(ptAngle - clickAngle);
        const adjDiff = Math.min(diff, 360 - diff);
        if (adjDiff < minDiff){
          minDiff = adjDiff;
          closestPt = pt;
        }
      });
      if (closestPt){
        selectedTime = closestPt.time;
        buildCircle();
      }
    };
  }

  // ===== FETCH & LIFECYCLE =====
  async function fetchUv(force=false){
    if (!isSettingsReady()){
      switchTab("settings"); return;
    }
    showLoading();
    if (!force && loadUvStorage()){
      // loaded from cache
      renderHome();
      return;
    }
    try {
      const url = `https://currentuvindex.com/api/v1/uvi?latitude=${settings.latitude}&longitude=${settings.longitude}`;
      const resp = await fetch(url);
      if(!resp.ok) throw new Error("HTTP "+resp.status);
      const data = await resp.json();
      uvData = data;
      saveUvStorage(data);
      renderHome();
    }
    catch(err){
      hideLoading();
      showMessage(`<div style="padding:24px; text-align:center">
        <p>Error loading UV data. Try again later.</p>
        <button onclick="fetchUv(true)">Retry</button>
      </div>`);
      console.error(err);
    }
  }

  // ===== SETUP =====
  function init(){
    // load settings
    loadSettings();
    inpLat.value = settings.latitude;
    inpLng.value = settings.longitude;
    inpSkin.value = settings.skinType;

    // tab events
    tabHome.onclick     = ()=>switchTab("home");
    tabSettings.onclick = ()=>switchTab("settings");

    // form
    form.onsubmit = e=>{
      e.preventDefault();
      settings.latitude  = inpLat.value.trim();
      settings.longitude = inpLng.value.trim();
      settings.skinType  = inpSkin.value;
      saveSettings();
      fetchUv(true);
      switchTab("home");
    };

    // refresh
    refreshBtn.onclick = ()=>fetchUv(true);

    // initial load
    if (isSettingsReady()){
      fetchUv(false);
    } else {
      renderHome();
    }
  }

  // bootstrap
  window.switchTab = switchTab;
  window.fetchUv   = fetchUv;
  document.addEventListener("DOMContentLoaded", init);
})();
</script>
</body>
</html>
